<!doctype html>
<html lang="en">
  <head>
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">

  

  

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="IPDK, or Infrastructure Programmer Development Kit, is an open source, vendor-agnostic framework of drivers and APIs for infrastructure offload and management that runs on a CPU or an IPU.  IPDK runs in Linux and uses a set of well-established tools such as SPDK, DPDK, Quick Assist and P4 to enable network virtualization, storage virtualization, workload provisioning, root-of-trust and offload capabilities found in the platform.  The components within IPDK, already optimized for Xeon servers, provide a common platform across CPUs and IPUs for increasing performance, optimizing resources and securing the infrastructure with an open-source eco-system.
">
  <meta name="author" content="TBD">

  <title>Inline Acceleration - IPsec</title>

  <link rel="stylesheet" href="../../../css/bootstrap.min.css">
  <link rel="stylesheet" href='https://fonts.googleapis.com/css?family=Roboto:400,900' type='text/css'>
  <link rel="stylesheet" href="../../../css/spdk.css">
  <link rel="stylesheet" href="../../../css/syntax.css">

  <link href="../../../feed.xml" type="application/atom+xml" rel="alternate" title="Atom Feed">

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>
</head>


  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-purp px-2">

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
    aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <a class="navbar-brand" href="../../../" aria-label="IPDK">
    <img src="../../../img/ipdk_mark_FIN_REV.svg" width="50" alt="Infrastructure Programmer Development Kit" />
  </a>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">

    <div class="navbar-nav mr-auto">
      
      
       <a class="nav-link header-link"  
        href="../../../download/">
        
        
        download
        
      </a>
      
      
       <a class="nav-link header-link"  
        href="../../../documentation/">
        
        
        documentation
        
      </a>
      
      
       <a class="nav-link header-link"  
        href="../../../development/">
        
        
        development
        
      </a>
      
      
       <a class="nav-link header-link"  
        href="../../../ci-status/">
        
        
        CI Status
        
      </a>
      
      
       <a class="nav-link header-link"  
        href="../../../community/">
        
        
        community
        
      </a>
      
      
       <a class="nav-link header-link"  
        href="../../../blog/">
        
        
        News
        
      </a>
      
    </div>

    <div class="navbar-nav ml-auto mr-3">
      <a class="nav-link header-link" href="https://github.com/ipdk-io">
      <svg xmlns="http://www.w3.org/2000/svg" class="navbar-nav-svg"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
      </a>
    </div>

  </div>

</nav>


    <div class="container-fluid">
      <div class="row">

        <div class="col-md-3 border-right border-dark">

          <nav class="navbar navbar-expand-md navbar-light">

            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navTableOfContents" aria-controls="navTableOfContents" aria-expanded="false" aria-label="Toggle Table of Contents">
              <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navTableOfContents">

              <div class="navbar-nav flex-column">
		<div class="collapse navbar-collapse" id="navTableOfContents">
<div class="navbar-nav flex-column">
  <ul class="no-bullets">
        
          
          <li class="nav-item">
            <a class="text-wrap collapsed" href="../../../documentation/Interfaces">Interfaces</a>
              
                <ul class="no-bullets">
                  
                      <li class="nav-item">
                        <a href="../../../documentation/Interfaces/InfraApp">Infrastructure Application Interface</a>
                        
                      </li>
                  
                      <li class="nav-item">
                        <a href="../../../documentation/Interfaces/TargetAbstraction">Target Abstraction Interface</a>
                        
                      </li>
                  
                </ul>
              
            </li>
            
          <li class="nav-item">
            <a class="text-wrap collapsed" href="../../../documentation/Recipes">Recipes</a>
              
                <ul class="no-bullets">
                  
                      <li class="nav-item">
                        <a href="../../../documentation/Recipes/InfrastructureNetworking">Virtual Networking</a>
                        
                      </li>
                  
                      <li class="nav-item">
                        <a href="../../../documentation/Recipes/VirtualBlockStorage">Virtual Block Storage</a>
                        
                      </li>
                  
                      <li class="nav-item">
                        <a href="../../../documentation/Recipes/InlineIPsec">Inline IPsec</a>
                        
                      </li>
                  
                      <li class="nav-item">
                        <a href="../../../documentation/Recipes/PaaSOffloadKubernetes">Kubernetes Offload</a>
                        
                      </li>
                  
                      <li class="nav-item">
                        <a href="../../../documentation/Recipes/FirewallInlineAcceleration">Inline Function Acceleration (Firewall Application)</a>
                        
                      </li>
                  
                </ul>
              
            </li>
            
          <li class="nav-item">
            <a class="text-wrap collapsed" href="../../../documentation/Targets">Targets</a>
              
                <ul class="no-bullets">
                  
                      <li class="nav-item">
                        <a href="../../../documentation/Targets/KVMTargetP4DPDK">KVM Target w/ P4 DPDK</a>
                        
                      </li>
                  
                      <li class="nav-item">
                        <a href="../../../documentation/Targets/OCTEON_DPU">OCTEON DPUs</a>
                        
                      </li>
                  
                      <li class="nav-item">
                        <a href="../../../documentation/Targets/MountEvansIPU">Mount Evans IPU</a>
                        
                      </li>
                  
                      <li class="nav-item">
                        <a href="../../../documentation/Targets/OakSpringsCanyonIPU">Oak Springs Canyon IPU</a>
                        
                      </li>
                  
                      <li class="nav-item">
                        <a href="../../../documentation/Targets/TofinoSwitch">Tofino-based Intelligent Switch</a>
                        
                      </li>
                  
                </ul>
              
            </li>
            
          <li class="nav-item">
            <a class="text-wrap collapsed" href="../../../documentation/Acronyms">Acronyms Glossary</a>
              
            </li>
            
        
    </ul>
  </div>
</div>
              </div>
            </div>
          </nav>
        </div>

        <div class="col-md-9 py-3 pl-5">

          <div class="jumbotron">
            <h1>Inline Acceleration - IPsec</h1>
          </div>

          <div class="content"><p>The Inline IPsec Recipe is an application that enables <a href="https://www.strongswan.org/">strongSwan</a> to use the <a href="https://ipdk.io/documentation/Interfaces/InfraApp/">Infrastructure Application Inteface</a>, specifically the P4Runtime and OpenConfig gRPCs provided by the <a href="https://ipdk.io/documentation/Recipes/InfrastructureNetworking/">Networking Recipe</a>. OpenConfig is used to configure security associations into the infrastructure and P4 is used program how and where the IPsec is inlined.</p>

<p>This recipe integrates the <a href="https://github.com/opiproject/opi-api/blob/main/security/proto/autogen.md">OPI Security API specification</a> to act as a northbound RPC to configure strongSwan remotely.</p>

<p><img src="../img/InlineIPsec_Recipe.svg" alt="Top Level Components" title="Inline IPsec Top Level" width="60%" /></p>

<h1 id="infrastructure-application-interface">Infrastructure Application Interface</h1>

<ul>
  <li><a href="https://www.strongswan.org/">strongSwan</a> is used as the IKE control plane.  No code changes are needed in strongSwan.</li>
  <li>A strongSwan plug-in is used to convert security association (SA) information into OpenConfig RPC messages to the underlying infrastructure.  The P4 program defines which modes are required in the pipeline, as well as where the IPsec is inserted into the broader virtual networking pipeline:
    <ul>
      <li><strong>Tunnel vs. Transport</strong>: Determines how the original packet is transformed during encryption/decryption as below: 
<img src="../img/IPsec_Packet_Transforms.svg" alt="IPsec Packet Transforms" title="IPsec Packet Transforms" width="60%" /></li>
      <li><strong>Encrypted Physical Ports</strong>: Encrypted tunnels between devices over physical ports.  On the wire this wraps additional headers on the outside of the packet in the same way that network virtualization headers such as VXLAN are added/removed.</li>
      <li><strong>Encrypted Virtual Ports</strong>: Encrypted virtual ports plugged into compute instances (all traffic going in/out of a given virtual port will be encrypted/decrypted).  On the wire this puts the IPsec headers onto the innermost headers belonging to the end user of the compute instance.</li>
    </ul>
  </li>
</ul>

<p>The use of cryptography to secure data plane traffic has become common practice. Encrypting and decrypting network traffic using host resources requires that the host must also perform any packet processing of post-decryption receive packets and pre-encryption transmit packets. This can consume significant host compute resources. Offloading packet crypto processing to the data plane removes the burden for cryptographic processing from the host and also allows the infrastructure to be used for pre-encryption and post-decryption packet processing functions.</p>

<p>This recipe looks at inline IPsec processing where the crypto is terminated in the infrastructure, which avoids having specialized drivers or control planes on the compute instance(s). The IPsec control plane (IKE protocol) is offloaded to the infrastructure. The IKE protocol processing runs in software on the infrastructure cores and programs the data plane with offloaded IPsec flows. The data plane programming is separated into two parts, P4Runtime for programming the P4 pipeline and OpenConfig for programming the IPsec crypto configuration. The IPsec crypto configuration includes the IPsec Security Association (SA) table entries (i.e. crypto keys and algorithm selection) and is used for reporting events related to lifetime expiration of SA entries. Rekeying and re-authentication configuration is set using OpenConfig and is translated into lower level dataplane updates at the Target Abstraction Interface.</p>

<h1 id="target-abstraction-interface">Target Abstraction Interface</h1>

<p>Targets supporting this application must export the following tables through the Table-Driven Interface:</p>

<ol>
  <li>P4 Tables compiled from the Inline IPsec P4 program.
    <ul>
      <li>Control blocks for Tunnel and Transport modes.</li>
      <li>Parser support for IPsec ESP</li>
      <li>Modify logic to encapsulate on the outer and inner headers of the packet.</li>
    </ul>
  </li>
  <li>IPsec OpenConfig schema based on the RFC
    <ul>
      <li>Configuration of the type &amp; strength of encryption</li>
      <li>Encryption keys w/ mechanisms to rekey</li>
      <li>Authentication &amp; Re-authentication mechanisms</li>
      <li>Classification</li>
      <li>Access Control Lists</li>
      <li>Designed to stay aligned with the <a href="https://github.com/opiproject/opi-api/blob/main/security/proto/autogen.md">OPI Security API specification</a></li>
    </ul>
  </li>
</ol>

<h2 id="tunnel-mode">Tunnel Mode</h2>

<p>The resulting logical pipelines for IPsec tunnel mode are illustrated below.</p>

<p><img src="../img/IPsec-IP-Tunnel-Pipelines.svg" alt="IPsec IP Tunnel Pipelines" title="IPsec IP Tunnel Pipelines" width="60%" /></p>

<h2 id="net_to_host-rx-pipeline-processing-elements">NET_TO_HOST (Rx) pipeline processing elements</h2>

<table class="table table=bordered">
  <thead>
    <tr>
      <th style="text-align: right">Step</th>
      <th style="text-align: left">Table</th>
      <th style="text-align: left">Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: left">IPsec Rx SA Classification Table</td>
      <td style="text-align: left">Maps Rx IPsec packets to IPsec SA entries using the packet header fields. Sets packet metadata to specify the SA index and to indicated that IPsec processing is required.</td>
    </tr>
    <tr>
      <td style="text-align: right">2</td>
      <td style="text-align: left">IPsec Crypto Engine</td>
      <td style="text-align: left">Decrypts and decapsulates IPsec ESP packets using the IPsec SA entry at the SA index specified in the packet metadata.</td>
    </tr>
    <tr>
      <td style="text-align: right">3</td>
      <td style="text-align: left">IPsec Rx Post Decrypt Table</td>
      <td style="text-align: left">Verifies that the crypto processing of the packet was successful (by checking packet metadata set by the engine). In IPsec tunnel mode: Removes the outer IP header.</td>
    </tr>
  </tbody>
</table>

<h2 id="host_to_net-tx-pipeline-processing-elements">HOST_TO_NET (Tx) pipeline processing elements:</h2>

<table class="table table=bordered">
  <thead>
    <tr>
      <th style="text-align: right">Step</th>
      <th style="text-align: left">Table</th>
      <th style="text-align: left">Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: left">IPsec Tx SPD Table</td>
      <td style="text-align: left">An optional ACL table that identifies Tx traffic that requires IPsec protection.</td>
    </tr>
    <tr>
      <td style="text-align: right">2</td>
      <td style="text-align: left">IPsec Tx SA Classification Table</td>
      <td style="text-align: left">Maps Tx packets to IPsec SA entries using the packet header fields. and packet metadata. Sets packet metadata to specify the SA index and to indicated that IPsec processing is required. In IPsec tunnel mode: Adds the outer IP header.</td>
    </tr>
    <tr>
      <td style="text-align: right">3</td>
      <td style="text-align: left">IPsec Crypto Engine</td>
      <td style="text-align: left">Encapsulates and encrypts IPsec ESP packets using the IPsec SA entry at the SA index specified in the packet metadata.</td>
    </tr>
  </tbody>
</table>

</div>
        </div>
      </div>
    </div>

    
  </body>
</html>
